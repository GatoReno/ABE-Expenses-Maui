<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:micro="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
             xmlns:utils="clr-namespace:AbeXP.Util"
             xmlns:controls="clr-namespace:AbeXP.Controls"
             xmlns:enums="clr-namespace:AbeXP.Common.Enum"
             x:Class="AbeXP.Views.FinantialChartsPage"
             Title="Gráficas">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="BannerColor">#4DCA92</Color>
            <Thickness x:Key="Padding">10</Thickness>

            <!--Style for the charts-->
            <Style TargetType="{x:Type controls:ChartViewRefreshable}" >
                <Setter Property="HeightRequest" Value="400"/>
                <Setter Property="Margin" Value="0,20,0,20"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!--<Shell.TitleView>
        <Grid BackgroundColor="{StaticResource BannerColor}" >
            <Label FontSize="Small" TextColor="White" VerticalOptions="Center" Text="" />
        </Grid>
    </Shell.TitleView>-->

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!--Expense total-->
        <Border BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource Primary}}" StrokeThickness="0" Padding="5, 15, 5, 15" Margin="20,0,20,10" StrokeShape="RoundRectangle 40,0,0,40">
            <VerticalStackLayout VerticalOptions="Center">
                <Label Text="{Binding TotalExpensesTitle}" HorizontalOptions="Center" TextColor="{StaticResource Black}"/>
                <Label HorizontalOptions="Center">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="$" TextColor="{StaticResource Black}" FontSize="23"/>
                            <Span Text="{Binding TotalExpensesAmount}" TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" FontSize="30" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
                <Label HorizontalOptions="Center" Margin="0,10,0,0">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="{Binding TotalExpensesCount}" TextColor="{AppThemeBinding Light={StaticResource Black}, Dark={StaticResource White}}" FontSize="16" />
                            <Span Text="{Binding CountExpensesTitle}" TextColor="{StaticResource Black}" FontSize="16"/>
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
            </VerticalStackLayout>
        </Border>


        <!--Select date range-->
        <HorizontalStackLayout Grid.Row="1" Padding="{StaticResource Padding}" HorizontalOptions="Center" >
            <controls:DatePickerWithIcon Title="Fecha inicial" Date="{Binding StartDate}" MaxDateAllowed="{Binding MaxStartDateAllowed}" MinDateAllowed="{Binding MinStartDateAllowed}" Margin="0,0,10,0"/>
            <controls:DatePickerWithIcon Title="Fecha final" Date="{Binding EndDate}" MaxDateAllowed="{Binding MaxEndDateAllowed}" MinDateAllowed="{Binding MinEndDateAllowed}"/>
            
            <!--search button, show loading spinner when busy-->
            <controls:ButtonWithContent Margin="15,0,0,-15" HeightRequest="35" WidthRequest="70"  VerticalOptions="Center"  Command="{Binding FilterExpensesCommand}" x:Name="btnSearch">
                <Grid BackgroundColor="Transparent">
                    <Label FontFamily="{StaticResource MaterialIconsRegular}" Text="{x:Static utils:MaterialIconsRegular.Search}" IsVisible="{Binding Source={x:Reference btnSearch}, Path=IsBusy, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=collapse}" HorizontalOptions="Center" VerticalOptions="Center" FontSize="20" TextColor="{StaticResource White}"/>
                    <ActivityIndicator Margin="5" IsRunning="{Binding Source={x:Reference btnSearch}, Path=IsBusy}" HorizontalOptions="Center" VerticalOptions="Center" />
                </Grid>
            </controls:ButtonWithContent>
        </HorizontalStackLayout>


        <ScrollView Grid.Row="2"  VerticalOptions="Start" Padding="{StaticResource Padding}">
            <VerticalStackLayout>
                <!--Expenses by period chart-->
                <Label FontAttributes="Bold" Text="{Binding ExpensesChartsTitle}"/>
                <VerticalStackLayout Grid.Row="2" >
                    <Label HorizontalOptions="Center" Text="{Binding TimePeriodTitle}"/>
                    <HorizontalStackLayout HorizontalOptions="Center">
                        <RadioButton x:Name="rb" GroupName="PeriodGroup" Content="3 días" Value="{x:Static enums:TimePeriod.ThreeDays}" IsChecked="{Binding Period, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={Static enums:TimePeriod.ThreeDays}}" />
                        <RadioButton GroupName="PeriodGroup" Content="semanal" Value="{x:Static enums:TimePeriod.Week}" IsChecked="{Binding Period, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={Static enums:TimePeriod.Week}}" />
                        <RadioButton GroupName="PeriodGroup" Content="mensual" Value="{x:Static enums:TimePeriod.Month}" IsChecked="{Binding Period, Mode=TwoWay, Converter={StaticResource EnumToBooleanConverter}, ConverterParameter={Static enums:TimePeriod.Month}}" IsEnabled="{Binding ExpensesMoreThanOneMonth}"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
                <controls:ChartViewRefreshable Chart="{Binding ExpensesLineChart}"/>

                <!--Expenses by payment category chart-->
                <Label FontAttributes="Bold" Text="{Binding PaymentTypeChartTitle}"/>
                <controls:ChartViewRefreshable Chart="{Binding PaymentsTypeDonutChart}"/>

                <!--Expenses by tags chart-->
                <Label FontAttributes="Bold" Text="{Binding TagsTypeChartTitle}"/>
                <controls:ChartViewRefreshable Chart="{Binding TagsBarChart}"/>
            </VerticalStackLayout>
        </ScrollView>


    </Grid>

</ContentPage>